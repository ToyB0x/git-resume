# repomixを利用したリポジトリコード理解の効率化

**更新日**: 2025/3/21
**確認日**: 2025/3/21

このファイルは、repomix MCPを利用して、git-resumeリポジトリのコードを効率的に理解するための方法をまとめたものです。AIとのやり取りにおけるトークン使用量を最適化しつつ、コードベースの全体像を短時間で把握するためのガイドラインを提供します。

## repomixとは

repomixは、リポジトリ全体またはディレクトリのコードを、AIが解析しやすい形式に圧縮・パッケージ化するツールです。特に大規模なコードベースを扱う際に、トークン使用量を削減しながら効率的にコードの構造と機能を理解するのに役立ちます。

## リポジトリ理解におけるrepomixの重要性

**特定のパッケージを調査する際は、かなり高い優先度でrepomixを使ってパッケージを分析するべきです。** その理由は以下の通りです：

1. **コード全体の文脈把握**: ファイルを個別に読むだけでは、コンポーネント間の関連性や大局的な設計意図を把握するのが困難です。repomixはコード間の関係性を保ちながら全体像を提供します。

2. **トークン効率の劇的な向上**: 特に大規模パッケージの場合、個別ファイルの読み込みは多くのトークンを消費し、AIの文脈窓を圧迫します。repomixは本質的な構造を維持しながら実装詳細を要約し、トークン使用量を大幅に削減します。

3. **一貫した理解の確保**: パッケージ全体を一度に解析することで、部分的な理解や誤解を防ぎ、より正確な推論と提案が可能になります。

4. **依存関係の可視化**: パッケージ内のモジュール間や外部依存関係を効率的に把握でき、副作用のないコード変更を促進します。

5. **開発効率と応答時間の向上**: 特定のパッケージが数十ファイル以上を含む場合、repomixを使わないと個別ファイルごとにAIのAPIサーバーとの通信が数十回以上発生し、人間に待ち時間のストレスを与え開発速度に悪影響を及ぼします。repomixを使用すれば、関数のシグネチャのみを効果的に分析でき、分析時間を大幅に短縮できます。

## repomixの階層別活用法

repomixは様々な階層でコードを解析できるため、分析の目的に合わせて使い分けることが重要です：

### 1. リポジトリ全体の分析
リポジトリの全体構造と主要コンポーネント間の関係性を把握したい場合に最適です。新しいプロジェクトに参加する際の最初のステップとして推奨されます。

### 2. 特定パッケージ/モジュールの分析
単一のパッケージやモジュールに集中して調査する場合に最適です。例えば、特定の機能を実装する前に関連するモジュールのコードを理解したい場合などに効果的です。

### 3. 特定ディレクトリの分析
コードベース内の特定のディレクトリ（例：コアロジック、UI層、データアクセス層など）に焦点を当てたい場合に有用です。

### 4. ファイルタイプによるフィルタリング
特定の言語やファイルタイプ（TypeScriptファイルのみなど）に焦点を当てた分析が必要な場合に活用できます。

## セットアップ方法

repomix MCPがまだ設定されていない場合は、以下の手順でセットアップを行います：

1. `npx -y repomix --mcp` を実行して、repomix MCPサーバーを起動します
2. Clineの設定ファイルに以下の設定を追加します：

```json
{
  "mcpServers": {
    "repomix": {
      "command": "npx",
      "args": ["-y", "repomix", "--mcp"],
      "env": {},
      "disabled": false,
      "autoApprove": []
    }
  }
}
```

## 効率的なコード理解の手順

### 1. リポジトリ全体のパッケージ化

```
repomixのpack_codebaseツールを使用して、リポジトリ全体をパッケージ化します：

<use_mcp_tool>
<server_name>repomix</server_name>
<tool_name>pack_codebase</tool_name>
<arguments>
{
  "directory": "/Users/user/github/survive",
  "compress": true
}
</arguments>
</use_mcp_tool>
```

### 2. 特定ディレクトリのパッケージ化（高優先度）

**リポジトリ内の特定パッケージを調査する場合は、最初にこの方法を使用してください：**

```
<use_mcp_tool>
<server_name>repomix</server_name>
<tool_name>pack_codebase</tool_name>
<arguments>
{
  "directory": "/Users/user/github/survive/apps/web",
  "compress": true
}
</arguments>
</use_mcp_tool>
```

これにより、個別のファイルを読む前に、パッケージの全体構造と主要コンポーネントの関係性を把握できます。実装の詳細を見る前に全体像を理解することで、より効果的なコード分析と提案が可能になります。

### 3. フィルタリングオプションの活用

特定のファイルタイプのみを含めたい場合は、includePatterns を使用します：

```
<use_mcp_tool>
<server_name>repomix</server_name>
<tool_name>pack_codebase</tool_name>
<arguments>
{
  "directory": "/Users/user/github/survive",
  "compress": true,
  "includePatterns": "**/*.ts,**/*.tsx"
}
</arguments>
</use_mcp_tool>
```

### 4. 重要ではないファイルの除外

テストファイルなど、現在のタスクに関連しないファイルを除外する場合：

```
<use_mcp_tool>
<server_name>repomix</server_name>
<tool_name>pack_codebase</tool_name>
<arguments>
{
  "directory": "/Users/user/github/survive",
  "compress": true,
  "ignorePatterns": "**/*.test.ts,**/*.spec.ts"
}
</arguments>
</use_mcp_tool>
```

## 効果的な使用シナリオ

1. **新しいプロジェクトの概要理解**: リポジトリに初めて取り組む際に、全体構造を把握
2. **特定の機能実装前の調査**: 関連コードを集中的に分析（**最優先で使用すべき**）
3. **リファクタリング前の依存関係把握**: コード間の関係性を理解
4. **バグ修正のための影響範囲特定**: 関連するコードモジュールを特定
5. **新機能の設計**: 既存アーキテクチャとの整合性を確保
6. **大規模パッケージの分析**: 数十ファイル以上を含むパッケージでは、個別に`read_file`を実行するよりもrepomixを使用した方が圧倒的に効率的

## 具体的な適用例

### 例1: 機能の実装前分析
新機能「ユーザーダッシュボード」を実装する場合：
1. まず関連モジュール全体を分析: `directory: "/apps/web"`
2. ユーザー関連コンポーネントに焦点: `directory: "/apps/web/app/routes"`
3. 既存のダッシュボード要素を調査: `includePatterns: "**/*dashboard*,**/*user*"`

### 例2: バグ修正のための分析
APIエンドポイントのバグ修正が必要な場合：
1. バックエンドAPIモジュール全体を分析: `directory: "/apps/api"`
2. 関連するルートハンドラに焦点: `directory: "/apps/api/src/routes"`
3. テストファイルは除外: `ignorePatterns: "**/*.test.ts"`

### 例3: パフォーマンス問題のトラブルシューティング
1. まずサービス層全体を分析: `directory: "/packages/services"`
2. 問題のあるサービスに焦点: `directory: "/packages/services/src/github"`
3. ユーティリティとヘルパー関数も調査: `directory: "/packages/utils"`

## コード理解のワークフロー

最も効率的なワークフローは以下の通りです：

1. **最初にrepomixでパッケージ分析**: 関連パッケージの全体像を把握
2. **コアコンポーネントの特定**: 重要なファイルやクラスを特定
3. **必要に応じて個別ファイル参照**: 詳細な実装を確認
4. **修正・実装の提案**: 全体構造を理解した上での的確な提案

## 注意点とベストプラクティス

1. トークン使用量とコード理解のバランスを取るため、必要に応じて圧縮レベルを調整してください
2. 大きなリポジトリの場合は、タスクに関連する部分だけをパッケージ化することを検討してください
3. フィルタパターンを効果的に使用して、関連性の高いファイルに焦点を当ててください
4. リポジトリの全体像を把握した後は、個別のファイルの詳細を確認するために標準の `read_file` ツールを使用することをお勧めします
5. 数十ファイル以上を含むディレクトリやパッケージを分析する場合は、個別ファイル読み込みではなく必ずrepomixを使用してください
6. 複数の関連パッケージを扱う場合は、まず各パッケージを別々に分析してから、関係性を把握するとよいでしょう

## トラブルシューティング

repomix MCPが正しく動作しない場合は、以下を確認してください：

1. Node.jsが最新バージョンであること
2. repomixパッケージが正しくインストールされていること
3. MCP設定ファイルの構文が正しいこと
4. ファイルパスが絶対パスで指定されていること

## Changelog

- 2025/3/21: repomixの階層別活用法と具体的な適用例を追加
- 2025/3/21: 大規模パッケージ分析時のAPI通信回数と処理時間の問題について説明を追加
- 2025/3/21: 特定パッケージ調査時のrepomix優先利用の重要性を強調する内容を追加
- 2025/3/21: 初回作成
