# @resume/api アーキテクチャ

**更新日**: 2025/3/29
**確認日**: 2025/3/29
**自動生成**: このドキュメントはAIによって自動生成されています

## 主要な設計思想

@resume/apiパッケージは、以下の設計思想に基づいて構築されています：

1. **軽量なWebフレームワーク** - Hono.jsを採用し、高速でスケーラブルなAPIサーバーを実現
2. **型安全性の確保** - TypeScriptとValibotを使用した厳格な型チェックとバリデーション
3. **リアルタイム通信** - Server-Sent Events（SSE）を活用したリアルタイムな進捗状況の通知
4. **モジュール分割** - 機能ごとに独立したモジュールに分割し、保守性と拡張性を向上
5. **共通サービスの活用** - @resume/servicesパッケージを活用し、ビジネスロジックの重複を回避

## 主要なモジュール構成

パッケージは以下の主要なモジュールで構成されています：

1. **エントリーポイント** (`src/index.ts`) - アプリケーションの起動とルーティングの設定
2. **GitHubルート** (`src/routes/api/github/`) - GitHubデータ取得とレジュメ生成に関するエンドポイント
   - `getUser.ts` - ユーザー情報取得とレジュメ生成エンドポイント
   - `getUserSse.ts` - レジュメ生成プロセスのリアルタイム通知エンドポイント
   - `mock.ts` - モックデータの提供
3. **ユーティリティ** (`src/utils/`) - 共通ユーティリティ関数
   - `env.ts` - 環境変数の型安全な取得
   - `sseHelper.ts` - SSE通信のヘルパー関数

## 主要な処理フロー

### レジュメ生成フロー（同期API）

1. **リクエスト受信** - `/api/github/:userName`エンドポイントがリクエストを受信
2. **パラメータバリデーション** - ユーザー名のバリデーション
3. **モードチェック** - デモモードの場合はモックデータを返却
4. **CLIコマンド実行** - 以下の順でCLIコマンドを実行
   - リポジトリのクローン
   - パッケージの作成
   - サマリーの生成
   - レジュメの生成
5. **レジュメファイル読み込み** - 生成されたレジュメファイルを読み込み
6. **レスポンス返却** - レジュメデータをJSON形式で返却

### レジュメ生成フロー（SSE）

1. **リクエスト受信** - `/api/github/:userName/progress`エンドポイントがリクエストを受信
2. **パラメータバリデーション** - ユーザー名のバリデーション
3. **SSEストリーム開始** - クライアントとのSSEストリームを確立
4. **接続イベント送信** - 接続確立を通知
5. **モードチェック** - デモモードの場合はシミュレーションを実行
6. **レジュメ生成プロセス実行** - 以下の順で処理を実行し、各ステップの進捗をリアルタイムに通知
   - GitHubリポジトリの検索
   - リポジトリのクローン
   - リポジトリの解析
   - サマリーの生成
   - レジュメの作成
7. **完了イベント送信** - 生成されたレジュメデータを含む完了イベントを送信
8. **ストリーム終了** - SSEストリームを適切に終了

## 外部依存関係

パッケージは以下の主要な外部依存関係を持ちます：

1. **Hono.js** - 高速なWebフレームワーク
2. **Valibot** - 軽量バリデーションライブラリ
3. **@supercharge/promise-pool** - 並行処理の制御
4. **@resume/models** - データモデル定義（ワークスペース内依存）
5. **@resume/services** - 共通サービス機能（ワークスペース内依存）

## エラーハンドリング戦略

1. **入力バリデーション** - Valibotを使用したパラメータのバリデーション
2. **例外ハンドリング** - try/catchブロックによる例外キャッチと適切なエラーレスポンス
3. **SSEでのエラー通知** - ストリーム中のエラーをイベントとして通知
4. **ログ記録** - エラー発生時の詳細なログ記録

## パフォーマンス最適化

1. **並行処理の制御** - Promise Poolを使用した並行処理数の制御
   - リポジトリクローンと分析: 最大3並行
   - サマリー生成: 1つずつ（レート制限対策）
2. **リソース使用量の最適化** - 子プロセスでのCLI実行によるメインプロセスのメモリ使用抑制
3. **早期バリデーション** - 不要な処理を回避するための早期パラメータバリデーション

## デプロイメント戦略

1. **コンテナ化** - Dockerを使用したコンテナ化
2. **クラウドサービス** - Google Cloud Runを使用したサーバーレスデプロイ
3. **CI/CD** - GitHub Actionsを使用した継続的インテグレーション/デプロイ

## 拡張性と保守性

このパッケージは以下の方針で拡張性と保守性を確保しています：

1. **モジュール分割** - 各機能は独立したモジュールとして実装され、変更の影響範囲を限定
2. **ファクトリーパターン** - Hono.jsのファクトリーパターンを活用し、ハンドラーの再利用性を向上
3. **環境変数の型安全な管理** - 環境変数をスキーマ定義し、型安全に使用
4. **共通ユーティリティ** - 繰り返し使用される機能を共通ユーティリティとして抽出